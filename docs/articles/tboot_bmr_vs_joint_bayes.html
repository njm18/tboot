<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bayesian Marginal Reconstruction Simulations • tboot</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Bayesian Marginal Reconstruction Simulations">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tboot</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tboot.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/exp_tilting.html">Exponential Tilting Simulations</a>
    </li>
    <li>
      <a href="../articles/tboot_bmr.html">Gettings Started with Bayesian Marginal Reconstruction</a>
    </li>
    <li>
      <a href="../articles/tboot_bmr_vs_joint_bayes.html">Bayesian Marginal Reconstruction Simulations</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nmorris-lilly/tboot">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Bayesian Marginal Reconstruction Simulations</h1>
                        <h4 class="author">Nathan Morris</h4>
            
            <h4 class="date">2020-07-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nmorris-lilly/tboot/blob/master/vignettes/tboot_bmr_vs_joint_bayes.Rmd"><code>vignettes/tboot_bmr_vs_joint_bayes.Rmd</code></a></small>
      <div class="hidden name"><code>tboot_bmr_vs_joint_bayes.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The following example is conceived to demonstrate the similarity of results from Bayesian Marginal Reconstruction (BMR) to full joint Bayesian analysis.</p>
<div id="the-example-scenario-and-simulated-datasets" class="section level2">
<h2 class="hasAnchor">
<a href="#the-example-scenario-and-simulated-datasets" class="anchor"></a>The Example Scenario and Simulated Datasets</h2>
<p>First, we create a sscenario where we assume we have 4 variables each of which is binary leading to <span class="math inline">\(2^4=16\)</span> possible outcomes in combination. We assign probabilities to each combination for 2 different simulated scenarios.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tboot)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">possible_values=<span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span>(<span class="dt">x1=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">1</span>),<span class="dt">x2=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">1</span>),<span class="dt">x3=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">1</span>),<span class="dt">x4=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(possible_values)</a></code></pre></div>
<pre><code>##      x1 x2 x3 x4
## [1,]  0  0  0  0
## [2,]  1  0  0  0
## [3,]  0  1  0  0
## [4,]  1  1  0  0
## [5,]  0  0  1  0
## [6,]  1  0  1  0</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">normalize=<span class="cf">function</span>(x) x<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#sceanario 1 assigns some probability to each possible_value</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">M=<span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">2.7</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4.05</span>, <span class="fl">-2.7</span>, <span class="dv">0</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">0.13</span>, <span class="fl">3.48</span>, <span class="fl">-3.13</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1.49</span>, <span class="fl">-2.12</span>, <span class="fl">2.9</span>, <span class="fl">-1.13</span>))</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">prob_<span class="dv">1</span>=<span class="kw">normalize</span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(possible_values, <span class="dv">1</span>, </a>
<a class="sourceLine" id="cb3-11" data-line-number="11">                            <span class="cf">function</span>(x) x<span class="op">%*%</span>M<span class="op">%*%</span>x))) </a>
<a class="sourceLine" id="cb3-12" data-line-number="12"></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#sceanario 2 exontially tilts scenario 1</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">prob_<span class="dv">2</span>=<span class="kw">normalize</span>(prob_<span class="dv">1</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(possible_values, <span class="dv">1</span>, </a>
<a class="sourceLine" id="cb3-15" data-line-number="15">                            <span class="cf">function</span>(x) <span class="fl">.5</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x)))) </a></code></pre></div>
<p>To understand the probabilities above consider the following correlation and mean for the binary variables being simulated:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">scenarioCorrelation=<span class="cf">function</span>(wt) {</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  mycov=<span class="kw"><a href="https://rdrr.io/r/stats/cov.wt.html">cov.wt</a></span>(possible_values,wt)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/cor.html">cov2cor</a></span>(mycov<span class="op">$</span>cov))</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">scenarioMean=<span class="cf">function</span>(w) </a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  <span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(possible_values,w))</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">scenarioCorrelation</span>(prob_<span class="dv">1</span>),<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##      x1   x2  x3  x4
## x1 1.00 0.75 0.5 0.3
## x2 0.75 1.00 0.6 0.2
## x3 0.50 0.60 1.0 0.5
## x4 0.30 0.20 0.5 1.0</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">scenarioMean</span>(prob_<span class="dv">1</span>),<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##       x1  x2  x3  x4
## [1,] 0.5 0.5 0.5 0.5</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">scenarioCorrelation</span>(prob_<span class="dv">2</span>),<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##      x1   x2   x3   x4
## x1 1.00 0.71 0.43 0.25
## x2 0.71 1.00 0.54 0.15
## x3 0.43 0.54 1.00 0.45
## x4 0.25 0.15 0.45 1.00</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">scenarioMean</span>(prob_<span class="dv">2</span>),<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##        x1   x2   x3   x4
## [1,] 0.78 0.78 0.78 0.72</code></pre>
<p>Next we simulate data sets with a range of sample sizes. For each possible sample size we simulate 20 datasets.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">sim =<span class="st"> </span><span class="cf">function</span>(N_per_datset,N_datasets, p) {</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(N_datasets, {</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">    index=<span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(possible_values), N_per_datset,<span class="dt">replace =</span> <span class="ot">TRUE</span>, <span class="dt">prob=</span>p)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    possible_values[index,]</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">  }, <span class="dt">simplify =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb12-7" data-line-number="7"></a>
<a class="sourceLine" id="cb12-8" data-line-number="8">ss=<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">200</span>, <span class="dv">400</span>)</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">sim_data_<span class="dv">1</span>=<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(ss, <span class="cf">function</span>(N_per_datset) </a>
<a class="sourceLine" id="cb12-10" data-line-number="10">  <span class="kw">sim</span>(N_per_datset,<span class="dv">20</span>,prob_<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">sim_data_<span class="dv">2</span>=<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(ss, <span class="cf">function</span>(N_per_datset) </a>
<a class="sourceLine" id="cb12-12" data-line-number="12">  <span class="kw">sim</span>(N_per_datset,<span class="dv">20</span>,prob_<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(sim_data_<span class="dv">1</span>)=<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(sim_data_<span class="dv">2</span>)=<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"N="</span>,ss)</a></code></pre></div>
</div>
<div id="the-posterior-from-bmr-and-full-bayesian-analysis-are-similar" class="section level2">
<h2 class="hasAnchor">
<a href="#the-posterior-from-bmr-and-full-bayesian-analysis-are-similar" class="anchor"></a>The Posterior from BMR and Full Bayesian Analysis are Similar</h2>
<p>Using the above simulated datasets we use marginal Bayesian calculations followed by BMR to sample from the joint posterior. We assume a simple uniform prior for the marginal simulations.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">2020</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#this function doest the actual analysis</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">get_post_bmr=<span class="st"> </span><span class="cf">function</span>(marginal_data,individual_data) {</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">  marginal=<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(marginal_data),</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">                  <span class="cf">function</span>(x) </a>
<a class="sourceLine" id="cb13-8" data-line-number="8">                    <span class="kw"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span>(<span class="dv">5000</span>,<span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x)<span class="op">+</span><span class="dv">1</span>, <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x<span class="op">==</span><span class="dv">0</span>) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">  w=<span class="kw"><a href="../reference/tweights_bmr.html">tweights_bmr</a></span>(individual_data, marginal,</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">                 <span class="dt">silent =</span> <span class="ot">TRUE</span>, <span class="dt">warningcut =</span> <span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw"><a href="../reference/post_bmr.html">post_bmr</a></span>(<span class="dv">5000</span>, w))</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb13-13" data-line-number="13"></a>
<a class="sourceLine" id="cb13-14" data-line-number="14"></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#If twieights or tboot throw an error or warning assume </span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co"># (i.e. BMR analysis should not be performed in these cases)</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17">missingSim=<span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="ot">NA</span>,<span class="dv">2500</span>,<span class="dv">4</span>); <span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(missingSim)=<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"x1"</span>,<span class="st">"x2"</span>,<span class="st">"x3"</span>,<span class="st">"x4"</span>)</a>
<a class="sourceLine" id="cb13-18" data-line-number="18"></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="co">#analyze all simulated datasets</span></a>
<a class="sourceLine" id="cb13-20" data-line-number="20">anayze_all_BMR=<span class="cf">function</span>(sim_dta, sim_dta_cor) {</a>
<a class="sourceLine" id="cb13-21" data-line-number="21">  <span class="kw"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span>(<span class="cf">function</span>(s1a,s2a) { <span class="co">#loop over sample sizes</span></a>
<a class="sourceLine" id="cb13-22" data-line-number="22">    <span class="kw"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span>(<span class="cf">function</span>(s1b,s2b) { <span class="co">#loop over simulations</span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23">      <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>(<span class="kw">get_post_bmr</span>(s2b, s2b), </a>
<a class="sourceLine" id="cb13-24" data-line-number="24">               <span class="dt">error=</span><span class="cf">function</span>(e) <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(missingSim),</a>
<a class="sourceLine" id="cb13-25" data-line-number="25">               <span class="dt">warning=</span><span class="cf">function</span>(w) <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(missingSim))</a>
<a class="sourceLine" id="cb13-26" data-line-number="26">    },s1a, s1a, <span class="dt">SIMPLIFY=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb13-27" data-line-number="27">  },sim_dta, sim_dta_cor, <span class="dt">SIMPLIFY=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb13-28" data-line-number="28">}</a>
<a class="sourceLine" id="cb13-29" data-line-number="29"></a>
<a class="sourceLine" id="cb13-30" data-line-number="30"><span class="co">#infer correlation from the same dataset</span></a>
<a class="sourceLine" id="cb13-31" data-line-number="31">bmr_results_<span class="dv">1</span>=<span class="kw">anayze_all_BMR</span>(sim_data_<span class="dv">1</span>,sim_data_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb13-32" data-line-number="32"></a>
<a class="sourceLine" id="cb13-33" data-line-number="33"><span class="co">#infer the correlation from a different dataset</span></a>
<a class="sourceLine" id="cb13-34" data-line-number="34">bmr_results_<span class="dv">2</span>=<span class="kw">anayze_all_BMR</span>(sim_data_<span class="dv">1</span>,sim_data_<span class="dv">2</span>)</a></code></pre></div>
<p>Next we analyze these datasets by using a fully Bayesian analysis. We consider that the prior probabilities assigned to each possible outcome (i.e., 2^4 possible outcomes) follow a Dirichlet prior with parameter rep(1/8,16). This prior is marginally uniform for each variable.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">rdirichlet  =<span class="st"> </span><span class="cf">function</span>(n, alpha) {</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span>(n<span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(alpha), alpha), <span class="dt">nrow=</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(alpha))  </a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(x) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(x)) </a>
<a class="sourceLine" id="cb14-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb14-5" data-line-number="5"></a>
<a class="sourceLine" id="cb14-6" data-line-number="6">joint_bayes=<span class="cf">function</span>(dta) {</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">  dta_factor=<span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(dta, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(x, <span class="dt">collapse =</span> <span class="st">","</span>)),</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">                    <span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(possible_values, </a>
<a class="sourceLine" id="cb14-9" data-line-number="9">                                   <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(x, <span class="dt">collapse =</span> <span class="st">","</span>)))</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">  tbl=<span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(dta_factor)</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">  post_prob=<span class="kw">rdirichlet</span>(<span class="dv">5000</span>, <span class="kw"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(tbl)<span class="op">+</span><span class="dv">2</span><span class="op">/</span>(<span class="dv">2</span><span class="op">^</span><span class="dv">4</span>))</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">  prob_proportions=post_prob <span class="op">%*%</span><span class="st"> </span>possible_values</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(prob_proportions)</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb14-15" data-line-number="15"></a>
<a class="sourceLine" id="cb14-16" data-line-number="16">anayze_all_joint=<span class="cf">function</span>(sim_dta, sim_dta_cor) {</a>
<a class="sourceLine" id="cb14-17" data-line-number="17">  <span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(sim_dta, <span class="cf">function</span>(sa) { <span class="co">#loop over sample sizes</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18">    <span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(sa, <span class="cf">function</span>(sb) { <span class="co">#loop over simulations</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19">      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">joint_bayes</span>(sb))</a>
<a class="sourceLine" id="cb14-20" data-line-number="20">    })</a>
<a class="sourceLine" id="cb14-21" data-line-number="21">  })</a>
<a class="sourceLine" id="cb14-22" data-line-number="22">}</a>
<a class="sourceLine" id="cb14-23" data-line-number="23"></a>
<a class="sourceLine" id="cb14-24" data-line-number="24">joint_results=<span class="kw">anayze_all_joint</span>(sim_data_<span class="dv">1</span>)</a></code></pre></div>
<p>Next we set up several functions to graphically compare the two methods. We will use a series of Bland–Altman plots to compare properties of the distributions. In all of these graphs, each dot represents a posterior values (such as median, correlation or quantile) from a simulated sample of size N.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co">#Extract any summary measure of interest for the data.</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="co"># g is the function that specifies which property to extract</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3">get_property=<span class="cf">function</span>(g) {</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">  ret=<span class="kw"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(rbind, <span class="kw"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span>(<span class="cf">function</span>(s1a,s2a,s3a, N) { <span class="co">#loop over sample sizes</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">    ret=<span class="kw"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(rbind,<span class="kw"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span>(<span class="cf">function</span>(s1b,s2b, s3b) { <span class="co">#loop over simulations</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">      J=<span class="kw">g</span>(s3b)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">      b1=<span class="kw">g</span>(s1b)</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">      b2=<span class="kw">g</span>(s2b)</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">N=</span>N, </a>
<a class="sourceLine" id="cb15-10" data-line-number="10">                        <span class="dt">analysis=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Marginals Generated</span><span class="ch">\n</span><span class="st">from Individual Data"</span>, </a>
<a class="sourceLine" id="cb15-11" data-line-number="11">                                   <span class="st">"Marginal Generated</span><span class="ch">\n</span><span class="st">from Seperate Data"</span>),</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">                        <span class="dt">dif=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(b1<span class="op">-</span>J, b2<span class="op">-</span>J),<span class="dt">mean=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>((b1<span class="op">+</span>J)<span class="op">/</span><span class="dv">2</span>, (b2<span class="op">+</span>J)<span class="op">/</span><span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb15-13" data-line-number="13">    },s1a,s2a,s3a, <span class="dt">SIMPLIFY =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">    ret<span class="op">$</span>sim_id=<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">1</span><span class="op">:</span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(ret)<span class="op">/</span><span class="dv">2</span>), <span class="dt">each=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(ret)</a>
<a class="sourceLine" id="cb15-16" data-line-number="16">  },bmr_results_<span class="dv">1</span>, bmr_results_<span class="dv">2</span>, joint_results, <span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(bmr_results_<span class="dv">1</span>), <span class="dt">SIMPLIFY =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb15-17" data-line-number="17">  <span class="kw"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(ret)=<span class="ot">NULL</span></a>
<a class="sourceLine" id="cb15-18" data-line-number="18">  ret=<span class="kw"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span>(ret)</a>
<a class="sourceLine" id="cb15-19" data-line-number="19">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(ret)</a>
<a class="sourceLine" id="cb15-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb15-21" data-line-number="21"></a>
<a class="sourceLine" id="cb15-22" data-line-number="22">make_graph=<span class="cf">function</span>(g,title) {</a>
<a class="sourceLine" id="cb15-23" data-line-number="23">  pltdta=<span class="kw">get_property</span>(g)</a>
<a class="sourceLine" id="cb15-24" data-line-number="24">  <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(pltdta, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">y=</span>dif, <span class="dt">x=</span>mean, <span class="dt">color=</span>N)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-25" data-line-number="25"><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(title) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="op">~</span>analysis) <span class="op">+</span></a>
<a class="sourceLine" id="cb15-26" data-line-number="26"><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="dt">yintercept=</span><span class="dv">0</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Difference(BMR-Joint)"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Mean (BMR+Joint)"</span>)</a>
<a class="sourceLine" id="cb15-27" data-line-number="27">}</a></code></pre></div>
<p>Now we investigate the marginals graphically. As may be seen the quantiles and median of the joint method and BMR are very similar. The similarity grows stronger as the sample size increases.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  <span class="kw">show</span>(<span class="kw">make_graph</span>(<span class="cf">function</span>(d) <span class="kw"><a href="https://rdrr.io/r/stats/median.html">median</a></span>(d[,i]), <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Median of X"</span>,i)))</a></code></pre></div>
<p><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-1.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-2.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-3.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-4.png" width="480"></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  <span class="kw">show</span>(<span class="kw">make_graph</span>(<span class="cf">function</span>(d) <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(d[,i], <span class="fl">.05</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">                  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"5% Quantile of X"</span>,i)))</a></code></pre></div>
<p><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-5.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-6.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-7.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-8.png" width="480"></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">  <span class="kw">show</span>(<span class="kw">make_graph</span>(<span class="cf">function</span>(d) <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(d[,i], <span class="fl">.95</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">                  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"95% Quantile of X"</span>,i)))</a></code></pre></div>
<p><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-9.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-10.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-11.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantile95-12.png" width="480"></p>
<p>Similarly we investigate the correlation between several variables. We will not print out all the correlations.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">  <span class="cf">for</span>(j <span class="cf">in</span> (i<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">  <span class="kw">show</span>(<span class="kw">make_graph</span>(<span class="cf">function</span>(d) <span class="kw"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(d[,i],d[,j]),</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">                  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Correlation of X"</span>,i, <span class="st">" and X"</span>,j )))</a></code></pre></div>
<p><img src="tboot_bmr_vs_joint_bayes_files/figure-html/cor-1.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/cor-2.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/cor-3.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/cor-4.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/cor-5.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/cor-6.png" width="480"></p>
<p>Next we investigate the quantiles in several random directional transformations of the space:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>) {</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">  direction=<span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">  direction=direction<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(direction<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">  <span class="kw">show</span>(<span class="kw">make_graph</span>(</a>
<a class="sourceLine" id="cb20-5" data-line-number="5">    <span class="cf">function</span>(d) {</a>
<a class="sourceLine" id="cb20-6" data-line-number="6">      <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(d <span class="op">%*%</span><span class="st"> </span>direction, <span class="fl">.95</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)},</a>
<a class="sourceLine" id="cb20-7" data-line-number="7">    <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Quantile of p %*% c("</span>,<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(direction,<span class="dv">2</span>), <span class="dt">collapse=</span><span class="st">","</span>),<span class="st">")"</span>)</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">  )</a>
<a class="sourceLine" id="cb20-9" data-line-number="9">  )</a>
<a class="sourceLine" id="cb20-10" data-line-number="10">}</a></code></pre></div>
<p><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantiledir-1.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantiledir-2.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantiledir-3.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantiledir-4.png" width="480"><img src="tboot_bmr_vs_joint_bayes_files/figure-html/quantiledir-5.png" width="480"></p>
<p>For all of these plots it may be seen that the BMR approach is quite similar to the full Bayes approach. The difference between quantiles and point estimates is very small on the y axis of each plot.</p>
</div>
<div id="trial-design-simulation-results" class="section level2">
<h2 class="hasAnchor">
<a href="#trial-design-simulation-results" class="anchor"></a>Trial Design Simulation Results</h2>
<p>Consider that we want to test the hypothesis for each variable that the proportion is 0.6. We wish to calculate the probability of succeeding (with p-value 0&lt;.05) on ALL 4 endpoints with a future trial sample size of 400. Note that simultanious success on 4 different endpoints requires that correlation between endpoints be appropriately considered.</p>
<p>Also, consider that the data available for trial design comes from a sample size of 50 patients as previously simulated. It is expected that a larger samples size for the design data would only make the results from different methods more similar. We will only look at 5 simulated datasets because the simulation is computationally expensive with 1000 future simulated trials based on each dataset.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">2020</span>)</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"></a>
<a class="sourceLine" id="cb21-3" data-line-number="3">sim_data_<span class="dv">1</span>_<span class="dv">50</span>=<span class="st"> </span>sim_data_<span class="dv">1</span>[[<span class="st">"N=50"</span>]][<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">sim_data_<span class="dv">2</span>_<span class="dv">50</span>=<span class="st"> </span>sim_data_<span class="dv">2</span>[[<span class="st">"N=50"</span>]][<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</a>
<a class="sourceLine" id="cb21-5" data-line-number="5"></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"></a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="co">#this function simulates a series of trials with success or failure</span></a>
<a class="sourceLine" id="cb21-8" data-line-number="8"><span class="co">#for each trial using tboot_bmr</span></a>
<a class="sourceLine" id="cb21-9" data-line-number="9">get_trial_pobS_bmr=<span class="st"> </span><span class="cf">function</span>(marginal_data,individual_data) {</a>
<a class="sourceLine" id="cb21-10" data-line-number="10">  marginal=<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(marginal_data),</a>
<a class="sourceLine" id="cb21-11" data-line-number="11">                  <span class="cf">function</span>(x) </a>
<a class="sourceLine" id="cb21-12" data-line-number="12">                    <span class="kw"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span>(<span class="dv">5000</span>,<span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x)<span class="op">+</span><span class="dv">1</span>, <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x<span class="op">==</span><span class="dv">0</span>) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb21-13" data-line-number="13"></a>
<a class="sourceLine" id="cb21-14" data-line-number="14">  w=<span class="kw"><a href="../reference/tweights_bmr.html">tweights_bmr</a></span>(individual_data, marginal,</a>
<a class="sourceLine" id="cb21-15" data-line-number="15">                 <span class="dt">silent =</span> <span class="ot">TRUE</span>, <span class="dt">warningcut =</span> <span class="fl">.15</span>)</a>
<a class="sourceLine" id="cb21-16" data-line-number="16">  S=<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(<span class="dv">1000</span>, {</a>
<a class="sourceLine" id="cb21-17" data-line-number="17">    dta=<span class="kw"><a href="../reference/tboot_bmr.html">tboot_bmr</a></span>(<span class="dv">400</span>, w)</a>
<a class="sourceLine" id="cb21-18" data-line-number="18">    p=<span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(dta)</a>
<a class="sourceLine" id="cb21-19" data-line-number="19">    se=<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(p<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>p)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(dta))</a>
<a class="sourceLine" id="cb21-20" data-line-number="20">    <span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(p<span class="fl">-.6</span>)<span class="op">/</span>se<span class="op">&gt;</span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span>(<span class="fl">0.975</span>) <span class="co">#success for a 2-sided alpha 0.05</span></a>
<a class="sourceLine" id="cb21-21" data-line-number="21">  }))</a>
<a class="sourceLine" id="cb21-22" data-line-number="22">  <span class="co">#return the proportion of time we succeed on all endpoints</span></a>
<a class="sourceLine" id="cb21-23" data-line-number="23">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(S,<span class="dv">1</span>,all))) </a>
<a class="sourceLine" id="cb21-24" data-line-number="24">}</a>
<a class="sourceLine" id="cb21-25" data-line-number="25"></a>
<a class="sourceLine" id="cb21-26" data-line-number="26"></a>
<a class="sourceLine" id="cb21-27" data-line-number="27"><span class="co">#this function simulates a series of trials with success or failure</span></a>
<a class="sourceLine" id="cb21-28" data-line-number="28"><span class="co">#for each trial using full Bayes analysis</span></a>
<a class="sourceLine" id="cb21-29" data-line-number="29">get_trial_probS_joint=<span class="st"> </span><span class="cf">function</span>(dta) {</a>
<a class="sourceLine" id="cb21-30" data-line-number="30">  dta_factor=<span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(dta, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(x, <span class="dt">collapse =</span> <span class="st">","</span>)),</a>
<a class="sourceLine" id="cb21-31" data-line-number="31">                    <span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(possible_values, </a>
<a class="sourceLine" id="cb21-32" data-line-number="32">                                   <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(x, <span class="dt">collapse =</span> <span class="st">","</span>)),</a>
<a class="sourceLine" id="cb21-33" data-line-number="33">                    <span class="dt">ordered =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb21-34" data-line-number="34">  tbl=<span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(dta_factor)</a>
<a class="sourceLine" id="cb21-35" data-line-number="35">  post_prob=<span class="kw">rdirichlet</span>(<span class="dv">1000</span>, <span class="kw"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(tbl)<span class="op">+</span><span class="dv">2</span><span class="op">/</span>(<span class="dv">2</span><span class="op">^</span><span class="dv">4</span>))</a>
<a class="sourceLine" id="cb21-36" data-line-number="36"></a>
<a class="sourceLine" id="cb21-37" data-line-number="37">  S=<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(post_prob, <span class="dv">1</span>, <span class="cf">function</span>(p) {</a>
<a class="sourceLine" id="cb21-38" data-line-number="38">    index=<span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(possible_values), <span class="dv">400</span>,<span class="dt">replace =</span> <span class="ot">TRUE</span>, <span class="dt">prob=</span>p)</a>
<a class="sourceLine" id="cb21-39" data-line-number="39">    dta=possible_values[index,]</a>
<a class="sourceLine" id="cb21-40" data-line-number="40">    p=<span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(dta)</a>
<a class="sourceLine" id="cb21-41" data-line-number="41">    se=<span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(p<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>p)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(dta))</a>
<a class="sourceLine" id="cb21-42" data-line-number="42">    <span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(p<span class="fl">-.6</span>)<span class="op">/</span>se<span class="op">&gt;</span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span>(<span class="fl">0.975</span>) <span class="co">#success </span></a>
<a class="sourceLine" id="cb21-43" data-line-number="43">  }))</a>
<a class="sourceLine" id="cb21-44" data-line-number="44">  <span class="co">#return the proportion of time we succeed on all endpoints</span></a>
<a class="sourceLine" id="cb21-45" data-line-number="45">  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(S,<span class="dv">1</span>,all))) </a>
<a class="sourceLine" id="cb21-46" data-line-number="46">}</a>
<a class="sourceLine" id="cb21-47" data-line-number="47"></a>
<a class="sourceLine" id="cb21-48" data-line-number="48"></a>
<a class="sourceLine" id="cb21-49" data-line-number="49"></a>
<a class="sourceLine" id="cb21-50" data-line-number="50"></a>
<a class="sourceLine" id="cb21-51" data-line-number="51"><span class="co">#infer correlation from the same dataset</span></a>
<a class="sourceLine" id="cb21-52" data-line-number="52">bmr_probS_<span class="dv">1</span>=<span class="kw"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span>(get_trial_pobS_bmr, sim_data_<span class="dv">1</span>_<span class="dv">50</span>, sim_data_<span class="dv">1</span>_<span class="dv">50</span>)</a></code></pre></div>
<pre><code>## Warning in value[[3L]](cond): Resimulating new draw from posterior becuase
## unable to find weights which achieve current sim from posterior. Optimization
## failed. Maximum iterations reached.</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co">#infer the correlation from a different dataset</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2">bmr_probS_<span class="dv">2</span>=<span class="kw"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span>(get_trial_pobS_bmr, sim_data_<span class="dv">1</span>_<span class="dv">50</span>, sim_data_<span class="dv">2</span>_<span class="dv">50</span>)</a></code></pre></div>
<pre><code>## Warning in .print_ret(originalDataset, weights = opt$weights, dataset, target, : Some of the weights are larger than 0.15. Thus your bootstrap sample may be overly dependent on a few samples. See vignette.</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="co">#perform full bayesian analysis</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2">joint_probS=<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(sim_data_<span class="dv">1</span>_<span class="dv">50</span>, get_trial_probS_joint)</a></code></pre></div>
<p>As may be seen below, the 3 methods yield very similar results.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(bmr_probS_<span class="dv">1</span>,bmr_probS_<span class="dv">2</span>,joint_probS))</a></code></pre></div>
<pre><code>##   bmr_probS_1 bmr_probS_2 joint_probS
## 1       0.143       0.133       0.165
## 2       0.122       0.167       0.145
## 3       0.733       0.698       0.701
## 4       0.280       0.275       0.288
## 5       0.099       0.089       0.098</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#introduction">Introduction</a><ul class="nav nav-pills nav-stacked">
<li><a href="#the-example-scenario-and-simulated-datasets">The Example Scenario and Simulated Datasets</a></li>
      <li><a href="#the-posterior-from-bmr-and-full-bayesian-analysis-are-similar">The Posterior from BMR and Full Bayesian Analysis are Similar</a></li>
      <li><a href="#trial-design-simulation-results">Trial Design Simulation Results</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nathan Morris, William Michael Landau.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
