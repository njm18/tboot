<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gettings Started with Bayesian Marginal Reconstruction • tboot</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Gettings Started with Bayesian Marginal Reconstruction">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tboot</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tboot.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/exp_tilting.html">Exponential Tilting Simulations</a>
    </li>
    <li>
      <a href="../articles/tboot_bmr.html">Gettings Started with Bayesian Marginal Reconstruction</a>
    </li>
    <li>
      <a href="../articles/tboot_bmr_vs_joint_bayes.html">Bayesian Marginal Reconstruction Simulations</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nmorris-lilly/tboot">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Gettings Started with Bayesian Marginal Reconstruction</h1>
                        <h4 class="author">Nathan Morris</h4>
            
            <h4 class="date">2020-07-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nmorris-lilly/tboot/blob/master/vignettes/tboot_bmr.Rmd"><code>vignettes/tboot_bmr.Rmd</code></a></small>
      <div class="hidden name"><code>tboot_bmr.Rmd</code></div>

    </div>

    
    
<div id="bayesian-marginal-reconstruction" class="section level1">
<h1 class="hasAnchor">
<a href="#bayesian-marginal-reconstruction" class="anchor"></a>Bayesian Marginal Reconstruction</h1>
<p>Suppose we are able summarize the current state of scientific knowledge for the mean/proportion of each of several endpoints for a particular treatment using a distribution. The distribution for each endpoint may come from the elicitation of prior information from experts, some initial dataset or some combination of different sources of information. In many cases it will be difficult to arrive at a joint distribution. Only the marginal distribution of each endpoint will be calculated easily. This is particularly true when using external published data where only marginal effects are known, and no patient level data is available. In general assuming independence for the distribution of the mean for each endpoint is not appropriate, as we would expect correlations in the distribution given that many endpoints are correlated. The method described here may be used to simulate from the approximate joint distribution given the marginal distribution and an individual level data set. The correlation structure within the individual level data is used to impute the joint distribution. The method also provides a way to simulate virtual trial data based on the marginal.</p>
</div>
<div id="a-simulated-example-dataset" class="section level1">
<h1 class="hasAnchor">
<a href="#a-simulated-example-dataset" class="anchor"></a>A simulated example dataset</h1>
<p>As and example, we simulate the following simple dataset with a continuous and two binary variables.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tboot)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">2020</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">quant1  &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="dv">200</span>) <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">bin1    &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>( (.<span class="dv">5</span><span class="op">*</span>quant1 <span class="op">+</span><span class="st"> </span><span class="fl">.5</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="dv">200</span>)) <span class="op">&gt;</span><span class="st"> </span><span class="fl">.5</span>, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">bin2    &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>( (.<span class="dv">5</span><span class="op">*</span>quant1 <span class="op">+</span><span class="st"> </span><span class="fl">.5</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="dv">200</span>)) <span class="op">&gt;</span><span class="st"> </span><span class="fl">.5</span>, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">simData &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(quant1, bin1, bin2)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(simData)</a></code></pre></div>
<pre><code>##        quant1 bin1 bin2
## 1  1.37697212    0    0
## 2  1.30154837    1    1
## 3 -0.09802317    0    0
## 4 -0.13040590    0    0
## 5 -1.79653432    0    0
## 6  1.72057350    0    1</code></pre>
</div>
<div id="example" class="section level1">
<h1 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h1>
<p>First, we create a list with simulations from the marginal distribution of each variable for two different treatments (active treatment and placebo).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">marginal_active &lt;-<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">quant1=</span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="dv">5000</span>, <span class="dt">mean=</span>.<span class="dv">5</span>, <span class="dt">sd=</span>.<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">                         <span class="dt">bin1=</span><span class="kw"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span>(<span class="dv">5000</span>, <span class="dt">shape1 =</span> <span class="dv">50</span>,<span class="dt">shape2=</span><span class="dv">50</span>),</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">                         <span class="dt">bin2=</span><span class="kw"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span>(<span class="dv">5000</span>, <span class="dt">shape1 =</span> <span class="dv">60</span>,<span class="dt">shape2=</span><span class="dv">40</span>))</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">marginal_pbo &lt;-<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">quant1=</span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="dv">5000</span>, <span class="dt">mean=</span>.<span class="dv">2</span>, <span class="dt">sd=</span>.<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">                      <span class="dt">bin1=</span><span class="kw"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span>(<span class="dv">5000</span>, <span class="dt">shape1 =</span> <span class="dv">20</span>,<span class="dt">shape2=</span><span class="dv">80</span>),</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">                      <span class="dt">bin2=</span><span class="kw"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span>(<span class="dv">5000</span>, <span class="dt">shape1 =</span> <span class="dv">30</span>,<span class="dt">shape2=</span><span class="dv">70</span>))</a></code></pre></div>
<p>We next need to use ‘tweights_bmr’ to calculate the correlation matrix from the data and get set for marginal reconstruction. The calculation uses a call to the ‘tweights’ function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">bmr_active &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tweights_bmr.html">tweights_bmr</a></span>(<span class="dt">dataset =</span> simData, <span class="dt">marginal =</span> marginal_active)</a></code></pre></div>
<pre><code>## ----------------------------------------------------------------
## Optimization was successful. The weights have a sampleing
## distribution with means close to the attemted target:
##                  quant1      bin1     bin2
## Achieved Mean 0.4968368 0.4992157 0.600457
## Target Mean   0.4968368 0.4992157 0.600457
## Maximum weight was:  0.04623098 
## Data augmented with 1 sample(s) with independent variables. 
## The final weight of the indpendent sample(s) was:  0.007398153 
## ----------------------------------------------------------------</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">bmr_pbo &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tweights_bmr.html">tweights_bmr</a></span>(<span class="dt">dataset =</span> simData, <span class="dt">marginal =</span> marginal_pbo)</a></code></pre></div>
<pre><code>## ----------------------------------------------------------------
## Optimization was successful. The weights have a sampleing
## distribution with means close to the attemted target:
##                  quant1      bin1      bin2
## Achieved Mean 0.1969663 0.2003352 0.2997904
## Target Mean   0.1969663 0.2003352 0.2997904
## Maximum weight was:  0.02418729 
## Data augmented with 1 sample(s) with independent variables. 
## The final weight of the indpendent sample(s) was:  0.006562899 
## ----------------------------------------------------------------</code></pre>
<p>To simulate from the posterior we use ‘post_bmr’:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">samples &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">trt=</span><span class="st">"active"</span>, <span class="kw"><a href="../reference/post_bmr.html">post_bmr</a></span>(<span class="dt">nsims=</span><span class="fl">1e3</span>, bmr_active)),</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">                 <span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">trt=</span><span class="st">"pbo"</span>, <span class="kw"><a href="../reference/post_bmr.html">post_bmr</a></span>(<span class="dt">nsims=</span><span class="fl">1e3</span>, bmr_pbo)))</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(samples)</a></code></pre></div>
<pre><code>##      trt    quant1      bin1      bin2
## 1 active 0.4909751 0.4588719 0.5872279
## 2 active 0.1522832 0.3929919 0.4903635
## 3 active 0.3521943 0.4217331 0.5940661
## 4 active 0.1911470 0.4232380 0.5223984
## 5 active 0.4904320 0.5739046 0.5425915
## 6 active 0.6137868 0.5463136 0.6449981</code></pre>
<p>The posterior samples show a correlations structure.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span>(samples[,<span class="op">-</span><span class="dv">1</span>], <span class="dt">col=</span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(samples<span class="op">==</span><span class="st">"active"</span>,<span class="st">"red"</span>,<span class="st">"blue"</span>), <span class="dt">pch=</span><span class="st">'.'</span>, <span class="dt">cex=</span>.<span class="dv">5</span>)</a></code></pre></div>
<p><img src="tboot_bmr_files/figure-html/pairsgraph-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Marginally the posterior samples are equivalent to the simulations used as input (i.e., in the ‘marginal’ parameter).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">pltdta=<span class="kw"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(rbind, <span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"quant1"</span>,<span class="st">"bin1"</span>, <span class="st">"bin2"</span>),</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">                             <span class="cf">function</span>(nm) {</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">                               <span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">type=</span><span class="st">"BMR"</span>, <span class="dt">var=</span>nm, <span class="dt">trt=</span>samples<span class="op">$</span>trt,</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">                                                <span class="dt">val=</span>samples[[nm]]), </a>
<a class="sourceLine" id="cb11-6" data-line-number="6">                                     <span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">type=</span><span class="st">"marginal"</span>, <span class="dt">var=</span>nm,</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">                                                <span class="dt">trt=</span><span class="st">"active"</span>, </a>
<a class="sourceLine" id="cb11-8" data-line-number="8">                                                <span class="dt">val=</span>marginal_active[[nm]]),</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">                                     <span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">type=</span><span class="st">"marginal"</span>, <span class="dt">var=</span>nm, </a>
<a class="sourceLine" id="cb11-10" data-line-number="10">                                                <span class="dt">trt=</span><span class="st">"pbo"</span>, </a>
<a class="sourceLine" id="cb11-11" data-line-number="11">                                                <span class="dt">val=</span>marginal_pbo[[nm]]))</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">                             }))</a>
<a class="sourceLine" id="cb11-13" data-line-number="13"></a>
<a class="sourceLine" id="cb11-14" data-line-number="14">  <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(pltdta, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">fill=</span>type, <span class="dt">x=</span>val)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span>(<span class="dt">alpha=</span>.<span class="dv">3</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(var<span class="op">~</span>trt, <span class="dt">scales =</span> <span class="st">"free"</span>)</a></code></pre></div>
<p><img src="tboot_bmr_files/figure-html/marginal%20dist-1.png" width="576" style="display: block; margin: auto;"></p>
<p>To simulate a random trial dataset using the parameters from a single draw of ‘post_bmr’ we use the tboot_bmr function. For example to simulate 100 patients on active treatment:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">active_sample=<span class="kw"><a href="../reference/tboot_bmr.html">tboot_bmr</a></span>(<span class="dt">nrow=</span><span class="dv">100</span>, <span class="dt">weights_bmr=</span>bmr_active)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(active_sample)</a></code></pre></div>
<pre><code>##       quant1 bin1 bin2
## 1  0.3944395    1    1
## 2 -0.4321196    0    0
## 3 -2.0566837    0    0
## 4 -1.2648538    0    0
## 5 -0.1767540    0    0
## 6 -2.0566837    0    0</code></pre>
<p>The underlying parameter mean for the simulation is an attribute:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(active_sample, <span class="st">"post_bmr"</span>)</a></code></pre></div>
<pre><code>##    quant1      bin1      bin2 
## 0.5927736 0.4617252 0.5994379</code></pre>
<p>A more interesting example would be to simulate and analyze trial data. For example:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co">#Manage any errors by assuming the pvalue failed to reach statistical</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="co">#significance (i.e. pvalue is 1) but keep track of such errors. </span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">errorTrackGlobal=<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">manageError=<span class="cf">function</span>(expr)  {</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span>(expr)), <span class="dt">error=</span><span class="cf">function</span>(e){</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">    errorTrackGlobal[[<span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(errorTrackGlobal)<span class="op">+</span><span class="dv">1</span>]] &lt;&lt;-<span class="st"> </span>e<span class="op">$</span>message</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">  }) </a>
<a class="sourceLine" id="cb16-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb16-10" data-line-number="10"></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="co">#create function to simulate and analyze one virtual trial</span></a>
<a class="sourceLine" id="cb16-13" data-line-number="13">sim_and_analyze=<span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb16-14" data-line-number="14">  active_sample=<span class="kw"><a href="../reference/tboot_bmr.html">tboot_bmr</a></span>(<span class="dv">100</span>, bmr_active)</a>
<a class="sourceLine" id="cb16-15" data-line-number="15">  pbo_sample=<span class="kw"><a href="../reference/tboot_bmr.html">tboot_bmr</a></span>(<span class="dv">100</span>, bmr_pbo)</a>
<a class="sourceLine" id="cb16-16" data-line-number="16">  <span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb16-17" data-line-number="17">    <span class="dt">p_quant1=</span><span class="kw">manageError</span>(<span class="kw"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span>(active_sample<span class="op">$</span>quant1,pbo_sample<span class="op">$</span>quant1)<span class="op">$</span>p.value),</a>
<a class="sourceLine" id="cb16-18" data-line-number="18">    <span class="dt">p_bin1=</span><span class="kw">manageError</span>(<span class="kw"><a href="https://rdrr.io/r/stats/fisher.test.html">fisher.test</a></span>(active_sample<span class="op">$</span>bin1,pbo_sample<span class="op">$</span>bin1)<span class="op">$</span>p.value),</a>
<a class="sourceLine" id="cb16-19" data-line-number="19">    <span class="dt">p_bin2=</span><span class="kw">manageError</span>(<span class="kw"><a href="https://rdrr.io/r/stats/fisher.test.html">fisher.test</a></span>(active_sample<span class="op">$</span>bin2,pbo_sample<span class="op">$</span>bin2)<span class="op">$</span>p.value)</a>
<a class="sourceLine" id="cb16-20" data-line-number="20">  )</a>
<a class="sourceLine" id="cb16-21" data-line-number="21">}</a>
<a class="sourceLine" id="cb16-22" data-line-number="22"><span class="co">#Simulate Pvalues</span></a>
<a class="sourceLine" id="cb16-23" data-line-number="23">p_sim=<span class="kw"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(rbind, <span class="kw"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(<span class="dv">100</span>, <span class="kw">sim_and_analyze</span>(), <span class="dt">simplify =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb16-24" data-line-number="24"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(errorTrackGlobal)</a></code></pre></div>
<pre><code>## list()</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(p_sim)</a></code></pre></div>
<pre><code>##       p_quant1     p_bin1     p_bin2
## 1 8.361678e-03 1.00000000 1.00000000
## 2 8.493083e-07 1.00000000 1.00000000
## 3 2.170874e-02 0.55474538 1.00000000
## 4 9.924969e-03 0.59836673 0.40612432
## 5 2.154656e-03 0.09505923 0.03519902
## 6 4.807536e-01 0.61658432 0.82775616</code></pre>
<p>The pvalue matrix above may be analyzed, for example, using the gMCP package if multiple testing adjustments are needed.</p>
</div>
<div id="methods" class="section level1">
<h1 class="hasAnchor">
<a href="#methods" class="anchor"></a>Methods</h1>
<div id="the-algorythm" class="section level2">
<h2 class="hasAnchor">
<a href="#the-algorythm" class="anchor"></a>The algorythm</h2>
<p>To describe the algorythm, we use the following notation:</p>
<ul>
<li>
<span class="math inline">\(k \in [1,2,...K]\)</span> is the endpoint endex for <span class="math inline">\(K\)</span> endpoints.</li>
<li>
<span class="math inline">\(y_{k}\)</span> is a vector of length <span class="math inline">\(J_k\)</span> of simulations of the marginal distribution of the mean of <span class="math inline">\(k^{th}\)</span> endpoint.</li>
<li>
<span class="math inline">\(X\)</span> is a matrix of input data with columns for each endpoint. <span class="math inline">\(X_{.k}\)</span> is the vector of data for the <span class="math inline">\(k^{th}\)</span> endpoint.</li>
<li>
<span class="math inline">\(\hat{y}_k\)</span> is the mean of <span class="math inline">\(y_{k}\)</span>.</li>
<li>
<span class="math inline">\(Q(y_{k}, p)\)</span> is the <span class="math inline">\(p^{th}\)</span> quantile of vector <span class="math inline">\(y_{k}\)</span>.</li>
</ul>
<p>The algorithm for ‘tweights_bmr()’ takes <span class="math inline">\(y_{k}\)</span> and <span class="math inline">\(X\)</span> as input and proceeds as follows:</p>
<ol style="list-style-type: decimal">
<li>Calculate <span class="math inline">\(\hat{y}_k\)</span>
</li>
<li>Use tboot to calculate the weights (<span class="math inline">\(w\)</span>) which would tilt <span class="math inline">\(X\)</span> such that the mean of <span class="math inline">\(w\cdot X_{.k} = \hat{y}_k\)</span> for all endpoints <span class="math inline">\(k\)</span>.<br>
</li>
<li>Calculate the implied weighted correlation (<span class="math inline">\(\hat{C}\)</span>) from using weights <span class="math inline">\(w\)</span> for <span class="math inline">\(X\)</span>.</li>
</ol>
<p>The algorithm for ‘post_bmr()’ takes the output from ‘tweights_bmr()’ and proceeds as follows:</p>
<ol style="list-style-type: decimal">
<li>Simulate <span class="math inline">\(Z \sim MultivariateNomal(mean=0, variance=\hat{C})\)</span><br>
</li>
<li>Simulate the posterior mean as <span class="math inline">\(y_k^* = Q(y_{k}, \Phi(Z_k))\)</span>
</li>
<li>Repeat steps 1 and 2 to generate more samples.</li>
</ol>
<p>The algorithm for ‘tboot_bmr()’ takes the output from ‘tweights_bmr()’ and proceeds as follows:</p>
<ol style="list-style-type: decimal">
<li>Simulate the posterior mean <span class="math inline">\(\mu\)</span> as in the algorithm above.</li>
<li>Use tweights and tboot to simulate data with a mean of <span class="math inline">\(\mu\)</span>. The option ‘Nindependent’ is always non-zero to help avoid errors. See the vignette on ‘tweights’ for more information on this option.</li>
</ol>
</div>
<div id="justifying-the-algorithm" class="section level2">
<h2 class="hasAnchor">
<a href="#justifying-the-algorithm" class="anchor"></a>Justifying the algorithm</h2>
<p>The algorithm described above may be justified in several ways. First, it is heuristically plausible. One would expect at first thought that when two variables are correlated, a drug which influences one of the variables will most likely influce the other. Second, in some specific cases, the algorythm may be justified via Bayesian Assymptotics using the ‘Berstein Von-Misus’ theorem. This document will not attempt to fully work out this more theoretical approach.</p>
</div>
<div id="considering-the-limits-of-tboot_bmr" class="section level2">
<h2 class="hasAnchor">
<a href="#considering-the-limits-of-tboot_bmr" class="anchor"></a>Considering the limits of ‘tboot_bmr’</h2>
<p>The following considerations should be relevent when considering the use of ‘tboot_bmr:’</p>
<ol style="list-style-type: decimal">
<li>Is the relationship between variables found in the available individual level data generalizable to the treatment of interest? That is if the individual data is tilted to reflect the expected mean of the treatment of interest, will the correlation be realisticly similar to the correlation of variable in the treatment of interest. In general, it is expected that the assumptions of ‘tboot’ will be more believable than the assumption of independence.</li>
<li>Is the individual level data sample size large enough to make inference about correlation?</li>
<li>Did the information about each variable come from different trials? In such cases it may be argued that for large samples sizes the distribution should be independent.</li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#bayesian-marginal-reconstruction">Bayesian Marginal Reconstruction</a></li>
      <li><a href="#a-simulated-example-dataset">A simulated example dataset</a></li>
      <li><a href="#example">Example</a></li>
      <li>
<a href="#methods">Methods</a><ul class="nav nav-pills nav-stacked">
<li><a href="#the-algorythm">The algorythm</a></li>
      <li><a href="#justifying-the-algorithm">Justifying the algorithm</a></li>
      <li><a href="#considering-the-limits-of-tboot_bmr">Considering the limits of ‘tboot_bmr’</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nathan Morris, William Michael Landau.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
